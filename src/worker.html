<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="referrer" content="no-referrer">

        <title>WebWorker</title>
    </head>

    <body>
        Web Worker API
    </body>

    <script async type="module">
        class WorkerEx extends Worker{
            #url = "";

            constructor(...sources){
                const url = URL.createObjectURL(new Blob([sources.map(s => s.toString().replace(/^function.+?\{/s, "").replace(/\}$/s, "").replace(/^\s+/gm, "").trim()).join("\n;\n")]));
                super(url);
                this.#url = url;
            }

            terminate(){
                super.terminate();
                URL.revokeObjectURL(this.#url);
            }
        }

        const worker = new WorkerEx(function(){
            globalThis.addEventListener("message", ({data})=>{
                const bytes = new Float32Array(data.buffer).map(() => Math.random());
                globalThis.postMessage(bytes, [bytes.buffer]);
            });
        });

        worker.addEventListener("message", ({data})=>{
            worker.terminate();
            console.log(data);
        });

        const bytes = new Float32Array(1024 * 1024 * 128);
        worker.postMessage(bytes, [bytes.buffer]);
    </script>
</html>