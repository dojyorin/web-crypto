<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="referrer" content="no-referrer">

        <title>I/O</title>
    </head>

    <body>
        <button type="button" id="read">Read</button>
        <button type="button" id="write">Write</button>
    </body>

    <script async type="module">
        function readFile(type, multiple, accept){
            const input = document.createElement("input");

            input.type = "file";
            input.multiple = !!multiple;
            input.accept = accept ?? "";

            return new Promise((res)=>{
                input.addEventListener("change", async()=>{
                    const files = await Array.from(input.files).map(async(file)=>{
                        return {
                            blob: file,
                            buffer: await file.arrayBuffer(),
                            byte: new Uint8Array(await file.arrayBuffer()),
                            text: await file.text(),
                            dataurl: await new Promise((_res)=>{
                                const reader = new FileReader();
                                reader.addEventListener("load", () => _res(reader.result), {once: true});
                                reader.readAsDataURL(file);
                            })
                        }[type];
                    });

                    res(input.multiple ? files : files[0]);
                }, {once: true});

                input.click();
            });
        }

        function writeFile(data, name){
            const link = document.createElement("a");

            link.href = URL.createObjectURL(data instanceof Blob ? data : new Blob([data]));
            link.download = name;
            link.click();

            URL.revokeObjectURL(link.href);
        }

        function openNotify(message){
            const dialog = document.createElement("dialog");

            dialog.style.position = "absolute";
            dialog.style.top = "10px";
            dialog.style.transition = "all 0.1s";
            dialog.style.border = "0";
            dialog.style.borderRadius = "8px";
            dialog.style.padding = "10px 15px";
            dialog.style.backgroundColor = "#CACACA";
            dialog.style.boxShadow = "2px 3px 4px 0 #0000004D";

            dialog.textContent = `\u{1F514} ${message}`;
            dialog.show();

            setTimeout(() => dialog.remove(), 5000);
            document.body.appendChild(dialog);
        }

        document.getElementById("read").addEventListener("click", async()=>{
            console.log(await readFile("buffer"));
            openNotify("Loaded!");
        });

        document.getElementById("write").addEventListener("click", ()=>{
            writeFile("test", "example.txt");
            openNotify("Saved!");
        });
    </script>
</html>